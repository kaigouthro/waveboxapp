!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["gmail-background"]=t():e["gmail-background"]=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function s(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(i,r,function(t){return e[t]}.bind(null,r));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t);const i=Symbol("privApi"),r=Symbol("privServiceId"),n=Symbol("privIsDestroyed"),a=Symbol("privOpenTimeouts"),o=Symbol("privOpenIntervals");var c=class{constructor(e,t){this[i]=e,this[r]=t,this[n]=!1,this[a]=new Set,this[o]=new Set}destroy(){this[n]||(Array.from(this[a]).forEach(e=>{clearTimeout(e)}),this[a].clear(),Array.from(this[o]).forEach(e=>{clearInterval(e)}),this[o].clear(),this[n]=!0)}isDestroyed(){return this[n]}throwOnDestroyed(){if(this[n])throw new Error("CoreBackground has been destroyed")}get STORE_DATA_TYPES(){return this[i].STORE_DATA_TYPES}get appVersion(){return this[i].appVersion}get api(){return this[i]}setTimeout(e,t){this.throwOnDestroyed();const s=setTimeout(()=>{this[a].delete(s),e()},t);return this[a].add(s),s}clearTimeout(e){clearTimeout(e),this[a].delete(e)}setInterval(e,t){this.throwOnDestroyed();const s=setInterval(e,t);return this[o].add(s),s}clearInterval(e){clearInterval(e),this[o].delete(e)}};var l=class{static isLoggedOutHTTPError(e){if(e){if("string"==typeof e.message&&-1!==e.message.indexOf("no credentials provided"))return!0;if(401===e.status&&"Unauthorized"===e.statusText)return!0}return!1}static _formatInt(e,t){const s=parseInt(e);return isNaN(s)?t:s}static _formatDate(e,t){const s=new Date(e);return isNaN(s)?t:s}static _formatUrl(e,t,s){try{return new e.libs.URL(t)}catch(e){return s}}static _getElementInt(e,t){return e?this._formatInt(e.textContent):t}static _getElementDate(e,t){return e?this._formatDate(e.textContent):t}static _getElementString(e,t){return e?e.textContent:t}static _atomXMLGmailMessageEntryToThread(e,t){const s=t.getElementsByTagName("author")[0],i=Array.from(t.getElementsByTagName("link")).find(e=>"alternate"===e.getAttribute("rel")),r=i?this._formatUrl(e,i.getAttribute("href")):void 0;return{id:this._getElementString(t.getElementsByTagName("id")[0]),messageId:r?r.searchParams.get("message_id"):void 0,modified:this._getElementDate(t.getElementsByTagName("modified")[0],new Date).getTime(),fromEmail:s?this._getElementString(s.getElementsByTagName("email")[0]):void 0,fromName:s?this._getElementString(s.getElementsByTagName("name")[0]):void 0,snippet:this._getElementString(t.getElementsByTagName("summary")[0],""),subject:this._getElementString(t.getElementsByTagName("title")[0],""),to:r?r.searchParams.get("account_id"):void 0}}static fetchGmailAtomUnreadInfo(e,t){return Promise.resolve().then(()=>e.fetch(t,{credentials:"include"})).then(e=>e.ok?Promise.resolve(e):Promise.reject(e)).then(e=>e.text()).then(t=>{const s=(new e.libs.xmldom.DOMParser).parseFromString(t,"text/xml");return Promise.resolve({email:this._getElementString(s.getElementsByTagName("title")[0],"").split(" ").slice(-1)[0],messages:Array.from(s.getElementsByTagName("entry")).map(t=>this._atomXMLGmailMessageEntryToThread(e,t)),count:this._getElementInt(s.getElementsByTagName("fullcount")[0],0),timestamp:this._getElementDate(s.getElementsByTagName("modified")[0],new Date).getTime()})})}static attemptAutoSignin(e){return Promise.resolve().then(()=>e.fetch("https://mail.google.com/mail/u/0/h/1pq68r75kzvdr/?v%3Dlui",{credentials:"include"})).then(e=>e.ok?Promise.resolve():Promise.reject(e))}};const h="Sync request already in-progress",m="Service store data unavailable",g="ServiceData store data unavailable",u="Signin request already in progress";var d=class{static syncInProgress(){return new Error(h)}static isSyncInProgress(e){return e&&e.message===h}static serviceUnavailable(){return new Error(m)}static serviceDataUnavailable(){return new Error(g)}static signinInProgress(){return new Error(u)}};function p(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const y=15e3,f=6e4,T=18e5;var v=class extends c{constructor(...e){super(...e),p(this,"handleForegroundMessage",(e,t,...s)=>{switch(t){case"count-changed":this.handleCountChanged(e,...s);break;case"avatar-changed":this.handleAvatarChanged(e,...s)}}),p(this,"handleServiceWatchFieldsChange",(e,t,s)=>{this.syncMessagesWithSingletonRetry().catch(()=>{}),t.syncInterval!==s.syncInterval&&this.syncMessagesOnPoll()}),p(this,"handleMachineResume",()=>{this.syncMessagesWithSingletonRetry().catch(()=>{})}),p(this,"handleUserRequestsSync",e=>{this.syncMessagesWithSingletonRetry().catch(()=>{})}),this.requests={messages:{open:!1,last:0},signin:{open:!1,last:0}},this.timers={fgCountChange:null,bgPoll:null},this.syncMessages().catch(()=>{}),this.syncMessagesOnPoll(),this.api.on("foreground-message",this.handleForegroundMessage),this.api.on("user-requests-sync",this.handleUserRequestsSync),this.api.on("service-watch-fields-changed",this.handleServiceWatchFieldsChange),this.api.on("machine-resume",this.handleMachineResume)}destroy(){this.api.removeListener("foreground-message",this.handleForegroundMessage),this.api.removeListener("user-requests-sync",this.handleUserRequestsSync),this.api.removeListener("service-watch-fields-changed",this.handleServiceWatchFieldsChange),this.api.removeListener("machine-resume",this.handleMachineResume),this.clearTimeout(this.timers.fgCountChange),this.clearTimeout(this.timers.bgPoll),super.destroy()}handleCountChanged(e,t,s){this.clearTimeout(this.timers.fgCountChange),this.timers.fgCountChange=this.setTimeout(()=>{this.syncMessages().catch(()=>{})},2e3)}handleAvatarChanged(e,t){this.api.setServiceAvatarUrl(t)}_getSyncFeedUrl(e){const t=e.constructor.INBOX_TYPES;switch(e.inboxType){case t.GMAIL_UNREAD:case t.GMAIL_UNREAD_ATOM:return"https://mail.google.com/mail/feed/atom/";case t.GMAIL_IMPORTANT:case t.GMAIL_STARRED:case t.GMAIL_PRIORITY:case t.GMAIL_IMPORTANT_ATOM:case t.GMAIL_STARRED_ATOM:case t.GMAIL_PRIORITY_ATOM:return"https://mail.google.com/mail/feed/atom/%5Eiim";case t.GMAIL_DEFAULT:case t.GMAIL_DEFAULT_ATOM:return"https://mail.google.com/mail/feed/atom/%5Esq_ig_i_personal";default:return"https://mail.google.com/mail/feed/atom/"}}_messagesToTrayMessages(e){return e.map(e=>{const{id:t,fromName:s,subject:i,modified:r,messageId:n}=e;return{id:t,text:`${s} : ${i||"No Subject"}`,extended:{title:i||"No Subject",subtitle:s,optSender:s,optAvatarText:(s||"")[0]},date:r,data:{serviceId:this.api.serviceId,messageId:n}}})}_messagesToNotifications(e){return e.map(e=>{const{id:t,fromName:s,fromEmail:i,snippet:r,subject:n,modified:a,messageId:o}=e;return{id:t,title:n||"No Subject",titleFormat:"text",body:[{content:[s,i?`<${i}>`:""].join(" ").trim(),format:"text"},{content:r,format:"text"}],timestamp:a,data:{serviceId:this.api.serviceId,messageId:o}}})}syncMessagesOnPoll(){if(this.isDestroyed())return;const e=this.api.getService(),t=e&&"number"==typeof e.syncInterval?e.syncInterval:6e4;this.clearTimeout(this.timers.bgPoll),this.timers.bgPoll=this.setTimeout(()=>{const e=(new Date).getTime();this.requests.messages.open?this.syncMessagesOnPoll():e-this.requests.messages.last<y?this.syncMessagesOnPoll():!this.api.isSleeping()&&e-this.requests.messages.last<f?this.syncMessagesOnPoll():this.syncMessages().catch(()=>Promise.resolve()).then(()=>this.syncMessagesOnPoll())},t)}syncMessagesWithSingletonRetry(e=1e3){return Promise.resolve().then(()=>this.syncMessages()).catch(t=>d.isSyncInProgress(t)?Promise.resolve().then(()=>new Promise(t=>{this.setTimeout(()=>{t()},e)})).then(()=>this.syncMessages()):Promise.reject(t))}syncMessages(){if(this.requests.messages.open)return Promise.reject(d.syncInProgress());const e=this.api.getService();return e?(this.requests.messages.open=!0,Promise.resolve().then(()=>l.fetchGmailAtomUnreadInfo(this.api,this._getSyncFeedUrl(e))).then(({count:e,timestamp:t,messages:s,email:i})=>{const{[this.api.STORE_DATA_TYPES.SERVICE]:r,[this.api.STORE_DATA_TYPES.SERVICE_DATA]:n}=this.api.getStoreData([this.api.STORE_DATA_TYPES.SERVICE,this.api.STORE_DATA_TYPES.SERVICE_DATA]);n.etag!==t&&this.api.updateServiceDataWithChangeset({etag:t,unreadCount:e,trayMessages:this._messagesToTrayMessages(s),notifications:this._messagesToNotifications(s)}),r.serviceDisplayName!==i&&this.api.setServiceDisplayName(i),this.api.setAuthUserId&&this.api.setAuthUserId(i),this.requests.messages.open=!1,this.requests.messages.last=(new Date).getTime()}).catch(e=>{const t=(new Date).getTime();return this.requests.messages.open=!1,this.requests.messages.last=t,l.isLoggedOutHTTPError(e)&&t-this.requests.signin.last>T?Promise.resolve().then(()=>this.autoSigninAtomFeed()).then(()=>this.syncMessages()):Promise.reject(e)}).catch(e=>(l.isLoggedOutHTTPError(e)&&this.api.setAuthInvalid(),Promise.reject(e))).then(()=>{this.api.setAuthValid()})):Promise.reject(d.serviceUnavailable())}autoSigninAtomFeed(){return this.requests.signin.open?Promise.reject(d.signinInProgress()):(this.requests.signin.open=!0,Promise.resolve().then(()=>l.attemptAutoSignin(this.api)).then(e=>(this.requests.signin.open=!1,this.requests.signin.last=(new Date).getTime(),Promise.resolve(e))).catch(e=>(this.requests.signin.open=!1,this.requests.signin.last=(new Date).getTime(),Promise.reject(e))))}};t.default=v}])});